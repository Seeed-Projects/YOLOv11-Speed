name: Build and Push Hailo-Compatible Docker Images for Python 3.13 on Raspberry Pi

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*.*.*' ]
  pull_request:
    branches: [ main, master ]

env:
  HAILO_VERSION: '4.23.0'  # Default Hailo version - override as needed
  PYTHON_VERSION: '3.13'

jobs:
  build-and-test-raspberry-pi:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    strategy:
      matrix:
        platform: [linux/arm/v7, linux/arm64]  # ARMv7 and ARM64 for Raspberry Pi

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      with:
        driver-opts: network=host

    - name: Build, test, and retry if needed for ${{ matrix.platform }}
      run: |
        MAX_RETRIES=3
        RETRY_COUNT=0

        # Replace forward slashes in platform name for valid Docker tag
        PLATFORM_TAG=$(echo "${{ matrix.platform }}" | sed 's|/|-|g')

        while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
          echo "Attempt $((RETRY_COUNT+1)) for ${{ matrix.platform }} (tag: $PLATFORM_TAG)"

          # Remove any existing test image
          docker rmi -f yolov11-hailo-detection:$PLATFORM_TAG-test || true

          # Build the Docker image for the specific platform
          if docker buildx build \
            --platform ${{ matrix.platform }} \
            --load \
            -t yolov11-hailo-detection:$PLATFORM_TAG-test \
            --build-arg HAILO_VERSION=${{ env.HAILO_VERSION }} \
            --cache-from=type=gha \
            --cache-to=type=gha,mode=max \
            . ; then

            echo "Build successful for ${{ matrix.platform }}"

            # Test the Docker image
            if timeout 60s docker run --rm yolov11-hailo-detection:$PLATFORM_TAG-test python3 -c "
            import sys
            print(f'Python version: {sys.version}')
            try:
                import cv2
                print(f'OpenCV version: {cv2.__version__}')
            except ImportError:
                print('OpenCV import failed')
                sys.exit(1)
            try:
                import numpy
                print(f'NumPy version: {numpy.__version__}')
            except ImportError:
                print('NumPy import failed')
                sys.exit(1)
            try:
                import flask
                print(f'Flask version: {flask.__version__}')
            except ImportError:
                print('Flask import failed')
                sys.exit(1)
            try:
                import loguru
                print(f'Loguru version: {getattr(loguru, \"__version__\", \"unknown\")}')
            except ImportError:
                print('Loguru import failed')
                sys.exit(1)
            print('Basic imports successful')
            "; then
              echo "Test passed for ${{ matrix.platform }}"
              break  # Exit the retry loop on success
            else
              echo "Test failed for ${{ matrix.platform }}"
            fi
          else
            echo "Build failed for ${{ matrix.platform }}"
          fi

          RETRY_COUNT=$((RETRY_COUNT+1))

          if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
            echo "Cleaning up and preparing for retry..."
            sleep 5  # Brief pause before retry
          fi
        done

        # If we exhausted all retries, exit with error
        if [ $RETRY_COUNT -ge $MAX_RETRIES ]; then
          echo "Failed to build and test successfully after $MAX_RETRIES attempts for ${{ matrix.platform }}"
          exit 1
        fi

        echo "Successfully built and tested for ${{ matrix.platform }} after $RETRY_COUNT attempt(s)"

  build-and-push:
    needs: build-and-test-raspberry-pi
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    if: github.event_name != 'pull_request'  # Only run on push, not PR

    strategy:
      matrix:
        platform: [linux/arm64, linux/arm/v7]  # ARM64 and ARMv7 for Raspberry Pi

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Extract metadata for Docker
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: |
          ghcr.io/${{ github.repository }}-hailo
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=sha,prefix={{branch}}-
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
          latest

    - name: Build and push Docker image for ${{ matrix.platform }}
      uses: docker/build-push-action@v5
      with:
        context: .
        platforms: ${{ matrix.platform }}
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        build-args: |
          HAILO_VERSION=${{ env.HAILO_VERSION }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Image digest
      run: echo ${{ steps.build-and-push.outputs.digest }}

  # Build and upload Docker images as GitHub Release assets when pushing a tag
  release:
    needs: build-and-push
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Needed to create releases and upload assets
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Extract tag name
      id: tag
      run: echo "tag=${GITHUB_REF#refs/*/}" >> $GITHUB_OUTPUT

    - name: Build Docker image locally for ARM64
      uses: docker/build-push-action@v5
      with:
        context: .
        load: true
        tags: yolov11-hailo-${{ steps.tag.outputs.tag }}:arm64
        build-args: |
          HAILO_VERSION=${{ env.HAILO_VERSION }}
        platforms: linux/arm64
        cache-from: type=gha
        cache-to: type=gha,mode=max
        outputs: type=docker,dest=/tmp/yolov11-hailo-${{ steps.tag.outputs.tag }}-arm64.tar

    - name: Build Docker image locally for ARMv7
      uses: docker/build-push-action@v5
      with:
        context: .
        load: true
        tags: yolov11-hailo-${{ steps.tag.outputs.tag }}:armv7
        build-args: |
          HAILO_VERSION=${{ env.HAILO_VERSION }}
        platforms: linux/arm/v7
        cache-from: type=gha
        cache-to: type=gha,mode=max
        outputs: type=docker,dest=/tmp/yolov11-hailo-${{ steps.tag.outputs.tag }}-armv7.tar

    - name: Save ARM64 image
      run: |
        docker save yolov11-hailo-${{ steps.tag.outputs.tag }}:arm64 -o /tmp/yolov11-hailo-${{ steps.tag.outputs.tag }}-arm64.tar

    - name: Save ARMv7 image
      run: |
        docker save yolov11-hailo-${{ steps.tag.outputs.tag }}:armv7 -o /tmp/yolov11-hailo-${{ steps.tag.outputs.tag }}-armv7.tar

    - name: Compress Docker images
      run: |
        gzip /tmp/yolov11-hailo-${{ steps.tag.outputs.tag }}-arm64.tar
        gzip /tmp/yolov11-hailo-${{ steps.tag.outputs.tag }}-armv7.tar

    - name: Create Release and Upload Assets
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.tag.outputs.tag }}
        name: Release ${{ steps.tag.outputs.tag }}
        body: |
          Docker images for YOLOv11 with Hailo support for Python 3.13 on Raspberry Pi

          - ARM64 Docker image: yolov11-hailo-${{ steps.tag.outputs.tag }}-
